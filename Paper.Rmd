---
title: "Simulating NFL Playoff Chances"
author: "Noah Sturgeon, Chase Bishop, Carter Nault"
output:
  pdf_document: default
  html_document: default
---
```{r win_probability_calculator}
get_opposite_index_of_value <- function(input_vector, target_index) {
  result <- which(input_vector == input_vector[target_index])
  return(result[result != target_index])
}

calculate_win_probabilities <- function(team_names, home_teams, elo, hfa, S) {
  win_probabilities <- rep(0, length(team_names))
  for(team in 1:length(team_names)) {
    if (is.na(home_teams[team])) {
      win_probabilities[team] <- NA
    }
    else if(team_names[team] == home_teams[team]) {
      away_team_index <- get_opposite_index_of_value(home_teams, team)
      exponent <- (-1*(elo[team] + hfa[team] - elo[away_team_index]))/S
      win_probabilities[team] <- 1/(1+10^exponent)
      win_probabilities[away_team_index] <- 1-win_probabilities[team]
    }
  }
  return(win_probabilities)
}
```

```{r game_simulator}
week_simulator <- function(team_names, home_teams, win_probabilities) {
  game_results <- rep(-1,length(team_names))
  for(team in 1:length(team_names)) {
    if(team_names[team] == home_teams[team]) {
      u <- runif(1, min = 0, max = 1)
      away_team_index <- get_opposite_index_of_value(home_teams, team)
      if(u < win_probabilities[team]) {
        game_results[team] <- 1
        game_results[away_team_index] <- 0
      } else {
        game_results[team] <- 0
        game_results[away_team_index] <- 1
      }
    }
  }
  return(game_results)
}

test_team_data |> mutate(week_results = week_simulator(Team_Name, Schedule, win_prob))
```

```{r elo_updater}
elo_updater <- function(win_probabilities, actual_results, elos, sensitivity) {
  K <- sensitivity
  for (team in 1:length(elos)) {
    if (!is.na(win_probabilities[team])) {
      elos[team] <- elos[team] + 
        K * (actual_results[team] - win_probabilities[team])
    }
  }
  return(elos)
}
```

```{r schedule_loader}
library(nflreadr)

schedule_by_week <- function(week_num) {
  schedule <- load_schedules(2025)
  
  away_teams <- schedule |>
    select(week, away_team, home_team, result) |>
    filter(week == week_num) |>
    rename(team = away_team) |>
    mutate(win = case_when(result < 0 ~ 1,
                           result == 0 ~ 0.5,
                           .default = 0)) |>
    select(team, home_team, win)
    
  home_teams <- schedule |>
    select(week, away_team, home_team, result) |>
    filter(week == week_num) |>
    mutate(team = home_team) |>
    mutate(win = case_when(result > 0 ~ 1,
                           result == 0 ~ 0.5,
                           .default = 0))  |>
    select(team, home_team, win)
  
  week_schedule <- bind_rows(away_teams, home_teams)
  return(week_schedule)
}
```

The schedule by week function takes NFL schedule data from the nflreadr package and takes the needed week number as an input, and outputs the week's schedule for each team with the home team for the scheduled game and if the team won, lost, tied, or did not play.


```{r elo_start}
standings_odds <- read_csv("2024_standings_2025_odds(in).csv")

hfa_data <- read_csv("NFL-HomeFieldAdvantage-Data.csv")

weights <- c(0.4, 0.6)
mean_elo <- 1000
scale <- 32

team_data <- standings_odds |>
  arrange(Tm) |>
  rename(Team_Name = Tm) |>
  mutate(Weighted_ProjW = weights[1] * W + weights[2] * ProjW) |>
  mutate(Elo = (Weighted_ProjW - 8.5) * scale + mean_elo) |>
  mutate(HFA = hfa_data$'Point Advantage') |>
  select(TCode, Team_Name, Elo, HFA)
```

Each team has a starting Elo which is a weighted average of last year's standings and the Vegas over-under line for wins from the preseason. Slightly more weight was placed on the over-under line to account for the changes in coaching and roster that an NFL team undergoes over the offseason, which would be considered in the preseason betting lines.

```{r elo_up_to_sim_start}
last_week <- 13

for (week in 1:last_week) {
  current_week_schedule <- schedule_by_week(week)
  current_week_schedule <- rename(current_week_schedule, TCode = team)
  sched_w_elo <- left_join(team_data, current_week_schedule)
  sched_w_elo$WP <- calculate_win_probabilities(sched_w_elo$TCode, sched_w_elo$home_team, sched_w_elo$Elo, sched_w_elo$HFA, 400)
  sched_w_elo$Elo <- elo_updater(sched_w_elo$WP, sched_w_elo$win, sched_w_elo$Elo, scale)
  team_data$Elo <- sched_w_elo$Elo
}
```

Using the week schedule, win probability and elo updater functions, the Elo of each team is updated for each week that has already been played in the season, which was up until week 13.


{r playoffseed}
'''
#Season Simulator 
# We need to sort by division

#AFC Divisions
AFC_North <- c("BAL","PIT", "CIN", "CLE")
AFC_East <- c("NE", "BUF", "MIA", "NYJ")
AFC_South <- c("JAX", "IND", "HOU", "TEN")
AFC_West <- c("KC", "LAC", "DEN", "LV")
#NFC Divisions
NFC_North <- c("CHI", "GB", "DET", "MIN")
NFC_East <- c("PHI", "DAL", "WAS", "NYG")
NFC_South <- c("TB", "CAR", "ATL", "NO")
NFC_West <- c("LAR", "SEA", "SF", "ARI")

divisions <- list(
  AFC_North = AFC_North,
  AFC_East = AFC_East, 
  AFC_South = AFC_South,
  AFC_West = AFC_West,
  
  NFC_North = NFC_North,
  NFC_East = NFC_East,
  NFC_South = NFC_South,
  NFC_West = NFC_West
)

conference <- list(
  AFC = c(AFC_North, AFC_East, AFC_South, AFC_West),
  NFC = c(NFC_North, NFC_East, NFC_South, NFC_West)
)
head(divisions)
head(conference)

#wins for testing (remove when finalizing)
wins <- c(
  # AFC
  BAL = 13, PIT = 11, CIN = 7, CLE = 6,
  NE  = 8,  BUF = 10, MIA = 9, NYJ = 6,
  JAX = 9,  IND = 7,  HOU = 12, TEN = 5,
  KC  = 13, LAC = 8,  DEN = 9, LV  = 7,
  
  # NFC
  CHI = 4,  GB  = 7,  DET = 12, MIN = 6,
  PHI = 11, DAL = 10, WAS = 5,  NYG = 4,
  TB  = 9,  CAR = 4,  ATL = 10, NO  = 8,
  LAR = 9,  SEA = 8,  SF  = 13, ARI = 3
)

division_standings <- function(divisions, team_names, wins){
  standings <- data.frame(
    division = divisions,
    team = team_names,
    wins = wins
  )
  standings <- standings[order(-standings$wins),]
  rownames(standings) <- NULL
  return(standings)
}


#division_standings sorts position in the division 


#Next we pull leader from each division
all_standings <- lapply(names(divisions), function(div){
  division_standings(div,divisions[[div]],wins[divisions[[div]]])
})

names(all_standings) <- names(divisions)

division_winners <- sapply(all_standings,function(df) df$team[1])
division_winners

AFC_divwinners <- division_winners[startsWith(names(division_winners), "AFC")]
NFC_divwinners <- division_winners[startsWith(names(division_winners), "NFC")]

AFC_nondivwin <- setdiff(conference$AFC, AFC_divwinners)
NFC_nondivwin <- setdiff(conference$NFC, NFC_divwinners)

AFC_wildcard <- sort(wins[AFC_nondivwin], decreasing = T)[1:3]
NFC_wildcard <- sort(wins[NFC_nondivwin], decreasing = T) [1:3]
#Then we get next 3 
AFC_wildcard
NFC_wildcard

#wins/records depending on how we are doing this
seed_placement <- function(winners, wildcards, wins){ 
  teams <- c(winners, names(wildcards))
  sorted <- sort(wins[teams], decreasing = T)
  return(sorted)
}

AFC_seedplacement <- seed_placement(AFC_divwinners, AFC_wildcard, wins)
NFC_seedplacement <- seed_placement(NFC_divwinners, NFC_wildcard, wins)
AFC_seedplacement
NFC_seedplacement

#Tie breaker clauses add
#Record <- Head to Head <- Division <- Conference <- Strength of Victory <- Strength of Schedule

# Playoff Seed
#AFC & NFC 1 seed First round bye
## 2 plays 7, 3 plays 6, 4 plays 5 
### HFA applies to higher seed (lower number)
#### Super Bowl ELO DIF

'''


References

HFA Data
